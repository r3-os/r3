name: Docs
on:
  push:
    branches: [ğŸ¦†, ğŸ“-*]

jobs:
  check:
    name: Build and Deploy Docs
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal

      - name: Install dependencies (Linux)
        run: .github/scripts/install-deno.sh
      - name: Set rustdoc flags
        run: |
          # [ref:doc_global_styling]
          echo "RUSTDOCFLAGS=--html-in-header `pwd`/src/r3/src/common.md" >> $GITHUB_ENV

      - name: Build Documentation
        uses: actions-rs/cargo@v1
        with:
          command: doc
          # Documentate all published packages with all features enabled [tag:doc_all_features]
          args: -p r3_port_std -p r3_port_arm -p r3_port_arm_m -p r3_port_riscv -p r3_support_rp2040 -p r3_support_rza1 -p r3_portkit -p r3_kernel -p r3 -p r3_core --all-features

      - name: Replace the non-local crate documentation with redirect pages to docs.rs
        run: deno run -A scripts/externalize-non-local-docs.ts -y

      - name: Check the generated documentation
        run: |
          # Don't fail the pipeline on errors because they are mostly minor
          deno run --allow-read scripts/check-doc.ts || true

      - name: Generate Badge
        run: |
          rev=`git show-ref --head HEAD | cut -b 1-7`
          wget -nv -O target/doc/badge.svg "https://img.shields.io/badge/docs-$rev-ok?style=for-the-badge"

      - name: Collect Output
        run: |
          mkdir output
          mv target/doc output
          touch output/.nojekyll

      - name: Copy Image
        run: |
          cp doc/logo-small.svg output

      # If we are on the main branch, deploy it to the website
      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@4.1.0
        if: github.ref == 'refs/heads/ğŸ¦†'
        with:
          branch: gh-pages
          folder: output
          single-commit: true

      # Otherwise, put it on the Actions page to allow download
      - name: Archive the generated documentation
        if: github.ref != 'refs/heads/ğŸ¦†'
        # use tar + compressor for faster upload and smaller artifact size
        run: |
          cd output
          tar -cv doc | xz > r3-api-docs.tar.xz

      - name: Upload the generated documentation as an artifact
        uses: actions/upload-artifact@v2
        if: github.ref != 'refs/heads/ğŸ¦†'
        with:
          name: r3-api-docs
          path: output/r3-api-docs.tar.xz
